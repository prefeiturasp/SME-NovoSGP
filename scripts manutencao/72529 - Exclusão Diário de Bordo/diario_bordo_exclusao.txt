------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--> Identifica diários de bordo duplicados/triplicados...	
;with DiariosBordoBase as (
	select db.aula_id, db.turma_id, db.componente_curricular_id, db.criado_rf, count(db.id) qtde 			
	from diario_bordo db 
	where db.criado_em >= '2022-01-01'  
	group by db.aula_id, db.turma_id, db.componente_curricular_id, db.criado_rf
	having count(db.id) > 1
	order by aula_id 
)
--> Detalha os diários de bordo a serem analisados
select distinct a.aula_id, a.turma_id, a.componente_curricular_id, a.criado_rf, db.id as diarioBordoId, excluido 
into tmp_fix72529_tratar
from DiariosBordoBase a
join diario_bordo db 
	on a.aula_id = db.aula_id 
   and db.turma_id = a.turma_id
   and db.componente_curricular_id = a.componente_curricular_id
   and db.criado_rf = a.criado_rf;

--> Obtém o diário de bordo mais atual de cada conjunto (aula, turma, componente e professor)
select distinct aula_id, turma_id, componente_curricular_id, criado_rf, max(diarioBordoId) as diarioBordoId  
into tmp_fix72529_validos
from tmp_fix72529_tratar where excluido = false
group by aula_id, turma_id, componente_curricular_id, criado_rf;

--> Identifica os diários a serem removidos
;with DiariosBordoExcluir as (
	select diarioBordoId from tmp_fix72529_tratar
	except 
	select diarioBordoId from tmp_fix72529_validos
)
select * into tmp_fix72529_excluir from DiariosBordoExcluir;

--> Realiza um backup das tabelas que serão excluídas
select db.* into tmp_fix72529_diario_bkp from diario_bordo db join tmp_fix72529_excluir e on e.diarioBordoId = db.id;
select db.* into tmp_fix72529_diario_observacao_bkp from diario_bordo_observacao db join tmp_fix72529_excluir e on e.diarioBordoId = db.diario_bordo_id;
	
--> Realiza a remoção dos diários e suas dependências
DO $$
declare
	diarios record;
begin
	FOR diarios IN SELECT * from tmp_fix72529_excluir  
		loop						
			delete from diario_bordo_observacao_notificacao where observacao_id in (select id from diario_bordo_observacao where diario_bordo_id = diarios.diariobordoid);		
			delete from diario_bordo_observacao where diario_bordo_id = diarios.diariobordoid;		     		
			delete from diario_bordo where id = diarios.diariobordoid;		
		END LOOP;
END$$;

--> Remover as tabelas usadas
drop table tmp_fix72529_tratar;
drop table tmp_fix72529_validos;
drop table tmp_fix72529_excluir;
drop table tmp_fix72529_diario_bkp;
drop table tmp_fix72529_diario_observacao_bkp;